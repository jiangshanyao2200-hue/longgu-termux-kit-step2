# UI PTY 交互终端（执行计划）

目标：把 `bash` 工具升级为“可交互的真实终端会话”，支持用户与 AI 协作完成需要 TTY 的命令（密码/y/n/ssh/ping 等），并确保输出可回收、可审计、可按需读取。

## 设计原则（取舍）
- 后端命令仍由 Termux 真正执行；前端只是展示/输入/控制。
- 优先高仿真：使用 PTY + ANSI/vt100 解析维护“屏幕缓冲”，而不是用 tmux 抓屏。
- 交互期间允许用户随时 `Home` 在“聊天历史”与“终端会话视图”间切换（会话不死）。
- 交互期间避免“上下键进入选择消息”的干扰：交互态下 `↑/↓` 改为“切换输入框焦点”。
- 用户输入默认完整回传给 AI（包含敏感信息）——按用户当前决策实现；后续可再补安全开关。

## 里程碑
### M1：PTY 会话跑通（可观测）
- 增加依赖：`portable-pty`（创建 PTY）、`vt100`（解析 ANSI 并维护屏幕缓冲）。
- 新增交互态运行结构：
  - 工具参数：`bash` 支持 `interactive:true`（由 AI 决定是否走交互路径）。
  - 后端：启动 PTY 子进程并持续读取输出，推送到主线程更新 UI（不再 `.output()` 等结束）。
  - UI：聊天区域临时切为“终端会话视图”，显示 vt100 屏幕内容（含滚屏/光标移动等）。

### M2：输入闭环（AI+人协作）
- 交互态出现“双输入框”时的焦点切换：
  - `↑/↓` 在交互态下切换焦点：`PTY` ↔ `Chat Input`。
  - 焦点在 `Chat Input` 时：`Enter` 把整行作为 stdin 发给 PTY，再清空输入框。
  - 焦点在 `PTY` 时：主要按键可直接转发（至少支持 `Enter/Backspace/Ctrl+C/Esc` 与普通字符）。
- `Home`：
  - 若存在活跃 PTY：`Home` 切换“聊天历史视图” ↔ “终端会话视图”（会话继续运行）。
  - 无 PTY 时：保持现有行为（退出选择模式 / 切换详情等）。

### M3：结果回收与大输出策略
- 输出阈值提升并对齐 Codex 体验（优先“可读/可回看”，避免过早截断）。
- 超量输出落盘：
  - 交互态与非交互态都支持把完整输出写入 `AItermux/system/log/bash-cache/`。
  - tool message 输出中写明 `saved_path`，AI 可用 `read_file/search` 分段检索。
- 超时由 AI 可控：
  - `bash` 支持 `timeout_secs/timeout_ms`（默认仍给一个保守值，交互态可设 `0` 仅靠手动终止）。
- 超时/错误提示“系统化”：
  - 避免混入过多建议性自然语言，优先结构化元信息（状态码、耗时、cwd、是否超时、缓存路径）。

## 验收点（最小可用）
- AI 发起 `{"tool":"bash","interactive":true,...}` 后：
  - 聊天区域可切到终端视图，实时看到输出刷新。
  - 用户可输入 y/n/密码并继续运行，最终能拿到退出状态与输出。
  - `Home` 可在终端视图与聊天历史间来回切换，会话不丢。
- 交互态下 `↑/↓` 不会触发“选择消息”。
- `cargo test` / `cargo build` 通过。

## 风险与元反思
- 终端仿真是系统工程：最小先做到“正确解析 ANSI 并稳定渲染”，颜色/鼠标/全屏 TUI 可后续迭代。
- 用户输入完整回传给 AI 会带来安全风险，但这是当前明确取舍；后续应补“敏感输入不记录”的可选策略。

---

## 当前实现状态（2026-02-04）
- `bash` 工具支持参数：`interactive:true/false`、`timeout_secs`、`timeout_ms`。
- 交互态（PTY）：
  - 启动即进入终端视图；`Home` 在“聊天 ↔ 终端”间切换（会话不中断）。
  - `↑/↓`（无 Ctrl）切换焦点：`Terminal` ↔ `Chat Input`；按住 `Ctrl` 时方向键允许转发给 PTY。
  - `Chat Input` 焦点下：`Enter` 把整行送入 PTY（自动补 `\\r`），并清空输入。
  - 鼠标滚轮/PgUp/PgDn：滚动 PTY 回看（不转发给进程）。
  - 终端区域有边框与标题 `Terminal`；焦点在终端时边框高亮。
- 非交互态（普通 bash）：
  - 超时可由 AI 指定；输出过大或被截断时，会落盘到 `AItermux/system/log/bash-cache/` 并在输出中返回 `saved:<path>` 供按需读取。
