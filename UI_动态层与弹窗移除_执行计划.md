# UI 动态层与弹窗移除（执行计划）

目标：彻底移除弹窗/窗口栈，把“思考/工具/正文”的信息展示收敛到**聊天流内**；优先稳定性与可测试性，避免在手机小屏上出现焦点混乱与 TUI bug 面。

---

## 0. 规格冻结（本轮取舍版）

### 0.1 思考（SSE/非 SSE）
- 用户发送消息后：思考区先出现 `●` 闪烁占位（降低延迟感，等待首段 reasoning）。
- 思考开始输出后：`●` 后面流式展示思考内容（斜体）。
- 思考结束后：停留 **5s**，随后自动隐藏（正文保留）。
- 回看/固定：选中 AI 正文后按 `←`，切换“固定/取消固定”该条思考。

### 0.2 正文
- 正文正常输出并保留，不做自动收敛/消失。

### 0.3 工具（默认极简，按需展开）
- 默认展示：`● <工具类型> · brief`（失败则尾部附 `（失败）` 轻提示）。
- `→` 展开/收起工具详情：展示解析后的头部 + brief + 截断后的输入/输出，便于审计与排错。
- `Tab`：全局切换简约/详情模式（只对最近 N 条做深度渲染，防卡顿）。
- 取舍：本轮不做“工具流式增量解析/滚动回放/收敛动画”，避免复杂状态机带来的稳定性风险。

### 0.4 交互（替代弹窗）
- 移除：所有弹窗逻辑、弹窗焦点、弹窗栈、相关设置项与旧命令入口。
- 聊天页：
  - `PgUp/PgDn`：滚动聊天
  - `Tab`：全局切换简约/详情模式
  - `↑/↓`：选择消息（输入框为空时）
  - `←`：展开/收起思考（选中 AI 正文时）
  - `→`：展开/收起工具详情（选中工具消息时）
  - `Enter`：复制选中消息到剪贴板（输入框为空时，依赖 `termux-clipboard-set`）
  - `Home`：退出选择模式（取消高亮）

---

## 1. 代码落地清单
- 已清理：全展开（`expand_all_tools/expand_all_thinking`）与工具结束后的“自动收敛/定时器”逻辑。
- 已实现：工具默认 brief（详情仅在 `→` 展开时渲染）。
- 已实现：思考仅展示本轮（并支持 `←` 固定），结束后按 5s 自动隐藏。
- 已实现：`Enter` 复制选中消息（调用 `termux-clipboard-set`）。

---

## 2. 验收清单
- 构建通过；`AItermux/system/selfcheck.sh` 通过。
- 默认视图“低噪音”：工具只显示 brief；思考会自动消失；正文保留。
- 新快捷键全部可用且互不冲突（滚动/选择/展开/复制）。
